<html>
<head>
<title>DBS</title>
</head>
<body>
<h1>DBS</h1>
<div id="mochi_white"></div>
<table border="1">
<tr><td /><td /><td /></tr>
<tr><td /><td /><td /></tr>
<tr><td /><td /><td /></tr>
<tr><td /><td /><td /></tr>
</table>
<div id="mochi_black"></div>
<script type="text/javascript" src="jquery-2.0.3.min.js"></script>

<script>

// ---- 言語拡張 ----

// 配列コピー
Array.prototype.clone = function(){
  var arr = []
  for(var i = 0;i < this.length;i++) arr[i] = this[i]
  return arr
}

// 正負反転
Array.prototype.negative = function(){
  var arr = []
  for(var i = 0;i < this.length;i++) arr[i] = -this[i]
  return arr
}

// 存在確認
Array.prototype.contains = function(obj){
  for(var i = 0;i < this.length;i++) {
    if(this[i] == obj) return true
  }
  return false
}

// ---- 定数定義----

// 駒定数定義
const SPACE = -1
const BABY = 0
const CHICKEN = 1
const ELEPHANT = 2
const GIRAFFE = 3
const LION = 4
const WHITE = 5

// 駒動き定義
const DIRECTIONS = [
  [-1, -1], [0, -1], [1, -1],
  [-1, 0], [1, 0],
  [-1, 1], [0, 1], [1, 1]
]

const BABY_MOVES = [-3]
const CHIKEN_MOVES = [-4, -3, -2, -1, 1, 3]
const ELEPHANT_MOVES = [-4, -2, 2, 4]
const GRAFFE_MOVES = [-3, -1, 1, 3]
const LION_MOVES = [-4, -3, -2, -1, 1, 2, 3, 4]

const MOVES = [
  BABY_MOVES, CHIKEN_MOVES, ELEPHANT_MOVES, GRAFFE_MOVES, LION_MOVES,
  BABY_MOVES.negative(), CHIKEN_MOVES.negative(), ELEPHANT_MOVES.negative(),
  GRAFFE_MOVES.negative(), LION_MOVES.negative(),
]

// 盤面表示
const BAN_ICON = [
  "　",
  "↑ひ", "↑に", "↑ぞ", "↑き", "↑ら",
  "↓ひ", "↓に", "↓ぞ", "↓き", "↓ら",
]

const MOCHI_ICON = [
  "ひよこ：", "にわとり：", "ぞう：", "きりん：", "らいおん："
]

const BAN_DEFAULT = [
  GIRAFFE + WHITE, LION + WHITE, ELEPHANT + WHITE,
  SPACE, BABY + WHITE, SPACE,
  SPACE, BABY, SPACE,
  ELEPHANT, LION, GIRAFFE
]

const MOCHI_DEFAULT = [
  0,0,0,0,0,
  0,0,0,0,0,
]

// ---- VIEW ----

// banを画面に反映する
function showBan(){
  var ban = gban.ban
  var mochi = gban.mochi

  for(var x = 0;x < 3;x++){
    for(var y = 0;y < 4;y++){
      var i = x + y * 3
      $("tr").eq(y).find("td").eq(x).text(BAN_ICON[ban[i] + 1])
    }
  }
  var t = ""
  for(var i = 0;i < WHITE;i++){
    if(0 < mochi[i]) t += MOCHI_ICON[i] + mochi[i]
  }
  $("#mochi_black").text(t)

  var t = ""
  for(var i = WHITE;i < WHITE * 2;i++){
    if(0 < mochi[i]) t += MOCHI_ICON[i % WHITE] + mochi[i]
  }
  $("#mochi_white").text(t)

}

// ---- Model ----

// 駒反転
function reverseBW(koma){
  return (1 - Math.floor(koma / WHITE)) * WHITE + (koma % WHITE)
}

// にわとりをひよこに戻す
function chikin2baby(koma){
  if(koma == CHICKEN) return BABY
  if(koma == CHICKEN + WHITE) return BABY + WHITE
  return koma
}

// 盤面
function Banmen(ban, mochi){
  this.ban = ban || BAN_DEFAULT.clone()
  this.mochi = mochi || MOCHI_DEFAULT.clone()
}

Banmen.prototype = {
  ban : BAN_DEFAULT.clone(),
  mochi : MOCHI_DEFAULT.clone(),
  
  // 盤面に対して手を実行する
  execute : function(hand){
    if(!hand) return

    var nextBan = this.clone()

    if(0 <= nextBan.ban[hand.to]){
      // 駒を取る
      nextBan.mochi[chikin2baby(reverseBW(nextBan.ban[hand.to]))]++
    }
    if(hand.from < 0){
      // 持ち駒使用
      var i = -hand.from - 1
      nextBan.mochi[i]--
      nextBan.ban[hand.to] = i
    } else {
      // 普通の移動
      nextBan.ban[hand.to] = nextBan.ban[hand.from] + (hand.reverse ? 1 : 0)
      nextBan.ban[hand.from] = SPACE
    }

    return nextBan
  },
  
  // コピーを作る
  clone : function(){
    return new Banmen(this.ban.clone(), this.mochi.clone())
  },

  // 合法手リストを取得する
  createLegalHands : function(isBlackTurn){
    var hands = []
    // 目的マスでループ
    for(var to = 0;to < this.ban.length;to++){
      var x = to % 3
      var y = Math.floor(to / 3)
      // 味方駒存在チェック
      if(isBlackTurn && 0 <= this.ban[to] && this.ban[to] < 5) continue
      if(!isBlackTurn && WHITE <= this.ban[to] && this.ban[to] < 5 + WHITE) continue
      // 周辺8マスの駒をサーチ
      for(var j = 0;j < DIRECTIONS.length;j++) {
        var fx = x + DIRECTIONS[j][0]
        var fy = y + DIRECTIONS[j][1]
        var from = fx + fy * 3
        // 境界
        if(fx < 0 || 3 <= fx || fy < 0 || 4 <= fy) continue
        // 手番の駒
        if(this.ban[from] < (isBlackTurn ? 0 : WHITE)
            || (isBlackTurn ? 4 : 4 + WHITE) < this.ban[from]) continue
        //
        if(MOVES[this.ban[from]].contains(to - from)){
          hands.push(new Hand(from, to))
          // 成チェック
          if(isBlackTurn && this.ban[from] == BABY && y == 0)
            hands.push(new Hand(from, to, true))
          if(!isBlackTurn && this.ban[from] == WHITE + BABY && y == 3)
            hands.push(new Hand(from, to, true))
        }
      }

      // 持ち駒打ち編
      // 駒存在チェック
      if(0 <= this.ban[to] && this.ban[to] < 5 + WHITE) continue
      // 持ち駒をサーチ
      for(j = 0;j < 5;j++) {
        var k = j + (isBlackTurn ? 0 : WHITE)
        if(this.mochi[k] <= 0) continue
        hands.push(new Hand(-1 - k, to))
      }
    }
    return hands
  },

}

// 手
function Hand(from, to, reverse){
  this.from = from == null ? -1 : from
  this.to = to == null ? -1 : to
  this.reverse = reverse || false
}

Hand.prototype = {
  from : -1,
  to : -1,
  reverse : false,
}

// ---- Utility Methods ----

// 手を実行して画面更新
function execute(hand){
  gban = gban.execute(hand)
  showBan()
}

// ---- メイン系 ----

// global object
var gban

$(function(){
  gban = new Banmen()
  showBan()
})
</script>
</body>
</html>